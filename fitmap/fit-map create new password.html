<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitMap - Create New Password</title>
    <link rel="stylesheet" href="./style.css">
</head>
<body>
    <div class="create-password-screen">
        <button class="back-button" onclick="goBack()">
            <img src="./Resources/Resource Icons/icons8-back-arrow-50.png" alt="back-arrow">
        </button>

        <div class="new-password-header">
            <div class="logo-container">
                <div class="dumbbell-icon">
                    <img src="./Resources/Resource Images/53819-removebg-preview.png" alt="">
                </div>
            </div>
        </div>

        <div class="new-password-content-card">
            <h1 class="create-title">Create a New Password</h1>
            <p class="create-description">
                Choose a strong password to keep your account secured
            </p>

            <form id="createPasswordForm">
                <div class="form-group">
                    <label class="form-label" for="newPassword">Enter New Password</label>
                    <div class="password-container">
                        <input 
                            type="password" 
                            id="newPassword" 
                            class="form-input" 
                            placeholder="******************"
                            required
                        >
                    </div>
                    <div class="password-requirements" id="passwordRequirements" style="display: none;">
                        <div class="requirement" id="req-length">
                            <span class="req-icon">○</span> At least 6 characters
                        </div>
                        <div class="requirement" id="req-uppercase">
                            <span class="req-icon">○</span> One uppercase letter
                        </div>
                        <div class="requirement" id="req-lowercase">
                            <span class="req-icon">○</span> One lowercase letter
                        </div>
                        <div class="requirement" id="req-number">
                            <span class="req-icon">○</span> One number
                        </div>
                    </div>
                    <div class="password-strength" id="passwordStrength" style="display: none;">
                        <div class="strength-bar">
                            <div class="strength-fill" id="strengthFill"></div>
                        </div>
                        <div class="strength-text" id="strengthText"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="confirmPassword">Confirm New Password</label>
                    <div class="password-container">
                        <input 
                            type="password" 
                            id="confirmPassword" 
                            class="form-input" 
                            placeholder="******************"
                            required
                        >
                    </div>
                    <div class="password-match" id="passwordMatch" style="display: none;"></div>
                </div>

                <button type="submit" class="create-button" id="createButton" disabled>Create Password</button>
            </form>
        </div>
    </div>

    <script>
        let resetEmail = '';

        // Check if code was verified
        window.addEventListener('load', function() {
            const codeVerified = localStorage.getItem('codeVerified');
            resetEmail = localStorage.getItem('resetEmail');

            if (!codeVerified || codeVerified !== 'true' || !resetEmail) {
                alert('Invalid session. Please start the password reset process again.');
                window.location.href = './fit-map reset password.html';
                return;
            }

            // Focus on password input
            document.getElementById('newPassword').focus();
        });

        function goBack() {
            window.location.href = './fit-map code verification.html';
        }

        function togglePassword(inputId) {
            const passwordInput = document.getElementById(inputId);
            passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
        }

        function checkPasswordRequirements(password) {
            const requirements = {
                length: password.length >= 6,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /[0-9]/.test(password)
            };

            // Update UI
            const reqEl = document.getElementById('passwordRequirements');
            if (password.length > 0) {
                reqEl.style.display = 'block';
                
                Object.keys(requirements).forEach(key => {
                    const element = document.getElementById(`req-${key}`);
                    const icon = element.querySelector('.req-icon');
                    
                    if (requirements[key]) {
                        element.classList.add('met');
                        icon.textContent = '✓';
                    } else {
                        element.classList.remove('met');
                        icon.textContent = '○';
                    }
                });
            } else {
                reqEl.style.display = 'none';
            }

            return requirements;
        }

        function checkPasswordStrength(password) {
            if (password.length === 0) return null;
            
            let score = 0;
            
            // Length check
            if (password.length >= 6) score++;
            if (password.length >= 8) score++;
            if (password.length >= 12) score++;
            
            // Character variety checks
            if (/[a-z]/.test(password)) score++;
            if (/[A-Z]/.test(password)) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[^A-Za-z0-9]/.test(password)) score++;
            
            if (score <= 2) return { level: 'weak', width: '33%', color: '#ff4444' };
            if (score <= 4) return { level: 'medium', width: '66%', color: '#ffa500' };
            return { level: 'strong', width: '100%', color: '#00C851' };
        }

        function updatePasswordStrength(password) {
            const strengthEl = document.getElementById('passwordStrength');
            const strengthFill = document.getElementById('strengthFill');
            const strengthText = document.getElementById('strengthText');
            const strength = checkPasswordStrength(password);
            
            if (!strength) {
                strengthEl.style.display = 'none';
                return;
            }
            
            strengthEl.style.display = 'block';
            strengthFill.style.width = strength.width;
            strengthFill.style.backgroundColor = strength.color;
            strengthText.textContent = strength.level.charAt(0).toUpperCase() + strength.level.slice(1) + ' password';
            strengthText.style.color = strength.color;
        }

        function checkPasswordMatch() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const matchEl = document.getElementById('passwordMatch');
            const createButton = document.getElementById('createButton');
            
            if (confirmPassword.length === 0) {
                matchEl.style.display = 'none';
                createButton.disabled = true;
                return;
            }
            
            matchEl.style.display = 'block';
            
            // Check if all requirements are met
            const requirements = checkPasswordRequirements(newPassword);
            const allRequirementsMet = Object.values(requirements).every(met => met);
            
            if (newPassword === confirmPassword && newPassword.length > 0) {
                matchEl.className = 'password-match match';
                matchEl.textContent = '✓ Passwords match';
                
                // Enable button only if all requirements are met
                createButton.disabled = !allRequirementsMet;
            } else {
                matchEl.className = 'password-match no-match';
                matchEl.textContent = '✗ Passwords do not match';
                createButton.disabled = true;
            }
        }

        // Event listeners
        document.getElementById('newPassword').addEventListener('input', function() {
            checkPasswordRequirements(this.value);
            updatePasswordStrength(this.value);
            checkPasswordMatch();
        });

        document.getElementById('confirmPassword').addEventListener('input', function() {
            checkPasswordMatch();
        });

        document.getElementById('createPasswordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }
            
            const requirements = checkPasswordRequirements(newPassword);
            const allRequirementsMet = Object.values(requirements).every(met => met);
            
            if (!allRequirementsMet) {
                showToast('Please meet all password requirements', 'error');
                return;
            }
            
            // Update password in localStorage
            const users = JSON.parse(localStorage.getItem('fitMapUsers') || '[]');
            const userIndex = users.findIndex(user => user.email === resetEmail);
            
            if (userIndex !== -1) {
                users[userIndex].password = newPassword;
                localStorage.setItem('fitMapUsers', JSON.stringify(users));
                
                // Clear reset session
                localStorage.removeItem('resetEmail');
                localStorage.removeItem('resetCode');
                localStorage.removeItem('resetCodeTimestamp');
                localStorage.removeItem('codeVerified');
                
                showToast('Password updated successfully! Redirecting...', 'success');
                
                // Redirect to sign in page
                setTimeout(() => {
                    window.location.href = './fit-map signin.html';
                }, 2000);
            } else {
                showToast('User not found. Please try again.', 'error');
            }
        });

        function showToast(message, type = 'info') {
            const existingToast = document.querySelector('.toast-message');
            if (existingToast) {
                existingToast.remove();
            }
            
            const colors = {
                success: '#00C851',
                error: '#ff4444',
                info: 'rgba(0, 0, 0, 0.8)'
            };
            
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background-color: ${colors[type]};
                color: white;
                padding: 12px 24px;
                border-radius: 25px;
                font-size: 14px;
                z-index: 9999;
                animation: slideDown 0.3s ease-out;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideUp 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Add CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideDown {
                from {
                    top: -50px;
                    opacity: 0;
                }
                to {
                    top: 20px;
                    opacity: 1;
                }
            }
            
            @keyframes slideUp {
                from {
                    top: 20px;
                    opacity: 1;
                }
                to {
                    top: -50px;
                    opacity: 0;
                }
            }

            .password-requirements {
                margin-top: 10px;
                padding: 12px;
                background: #f8f8f8;
                border-radius: 8px;
            }

            .requirement {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 4px 0;
                font-size: 13px;
                color: #666;
                transition: color 0.3s;
            }

            .requirement.met {
                color: #00C851;
            }

            .req-icon {
                font-size: 14px;
                font-weight: bold;
                width: 16px;
            }

            .password-strength {
                margin-top: 10px;
            }

            .strength-bar {
                height: 6px;
                background: #e0e0e0;
                border-radius: 3px;
                overflow: hidden;
                margin-bottom: 5px;
            }

            .strength-fill {
                height: 100%;
                transition: width 0.3s, background-color 0.3s;
                width: 0%;
            }

            .strength-text {
                font-size: 12px;
                font-weight: 600;
            }

            .password-match {
                margin-top: 8px;
                font-size: 13px;
                font-weight: 500;
            }

            .password-match.match {
                color: #00C851;
            }

            .password-match.no-match {
                color: #ff4444;
            }

            .create-button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .create-button:not(:disabled):hover {
                opacity: 0.9;
                transform: translateY(-1px);
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>